{% extends "base.html" %}

{% block title %}Invoice - ICSS India{% endblock %}

{% block extra_js %}
{% if idor_flag %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        showFlagPopup(
            'idor',
            "{{ idor_flag }}",
            'IDOR - Insecure Direct Object Reference',
            'You accessed another user\'s invoice without authorization! No ownership validation was performed on /invoice/{id}.'
        );
    }, 400);
});
</script>
{% endif %}
{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="card shadow-lg fade-in-up">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Invoice Details</h3>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="badge bg-success px-3 py-2">PAID</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-5">
                <div class="row mb-4">
                    <div class="col-md-6 fade-in-left">
                        <h2 class="text-primary mb-3">ICSS India</h2>
                        <p class="mb-1"><i class="fas fa-map-marker-alt text-primary me-2"></i>ICSS, 3rd Floor, Eros Metro Mall</p>
                        <p class="mb-1">Sector-14, Dwarka</p>
                        <p class="mb-1">New Delhi, 110078</p>
                        <p class="mb-1"><i class="fas fa-phone text-primary me-2"></i>+011-69651424</p>
                        <p class="mb-0"><i class="fas fa-envelope text-primary me-2"></i>info@icssindia.in</p>
                    </div>
                    <div class="col-md-6 text-end fade-in-right">
                        <h4 class="text-muted mb-3">Invoice #{{ invoice.id }}</h4>
                        <p class="mb-1"><strong>Issue Date:</strong> {{ invoice.created_at }}</p>
                        <p class="mb-1"><strong>Student:</strong> {{ invoice.username }}</p>
                        <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">Paid</span></p>
                    </div>
                </div>

                <hr class="my-4">

                <div class="table-responsive fade-in-up">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="60%">Course Description</th>
                                <th width="20%" class="text-center">Duration</th>
                                <th width="20%" class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>{{ invoice.course_name }}</strong>
                                    <br><small class="text-muted">Professional Training Program</small>
                                </td>
                                <td class="text-center">12 Weeks</td>
                                <td class="text-end">₹{{ invoice.amount }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2" class="text-end"><strong>Subtotal:</strong></td>
                                <td class="text-end">₹{{ invoice.amount }}</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="text-end"><strong>Tax (18% GST):</strong></td>
                                <td class="text-end">₹{{ (invoice.amount * 0.18)|int }}</td>
                            </tr>
                            <tr class="table-primary">
                                <td colspan="2" class="text-end"><strong>Total Amount:</strong></td>
                                <td class="text-end"><strong>₹{{ (invoice.amount * 1.18)|int }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                {% if invoice.flag_data %}
                <div class="alert alert-success mt-4 fade-in-up">
                    <h5><i class="fas fa-flag-checkered me-2"></i>IDOR FLAG FOUND!</h5>
                    <p class="mb-0 font-monospace">{{ invoice.flag_data }}</p>
                </div>
                {% endif %}

                {% if idor_flag %}
                <div class="alert alert-danger mt-4 fade-in-up">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>IDOR Vulnerability Exploited!</h5>
                    <p class="mb-1">You accessed invoice #{{ invoice.id }} belonging to user <strong>{{ invoice.username }}</strong>.</p>
                    <p class="mb-0 font-monospace text-success fw-bold">{{ idor_flag }}</p>
                </div>
                {% endif %}

                <div class="mt-4 p-3 bg-light rounded fade-in-up">
                    <h6><i class="fas fa-info-circle text-primary me-2"></i>Payment Information</h6>
                    <p class="mb-1"><strong>Payment Method:</strong> Online Transfer</p>
                    <p class="mb-1"><strong>Transaction ID:</strong> TXN{{ invoice.id }}202601</p>
                    <p class="mb-0"><strong>Payment Status:</strong> <span class="badge bg-success">Completed</span></p>
                </div>

                <div class="mt-4 text-center fade-in-up">
                    <button onclick="window.print()" class="btn btn-secondary me-2">
                        <i class="fas fa-print me-2"></i>Print Invoice
                    </button>
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
            <div class="card-footer text-center text-muted fade-in-up">
                <small>Thank you for choosing ICSS India. For any queries, contact support@icssindia.in</small>
            </div>
        </div>
    </div>
</section>
{% endblock %}

<!-- IDOR Vulnerability: Try accessing /invoice/1 (admin invoice) -->
<!-- No ownership validation is performed on invoice access -->
