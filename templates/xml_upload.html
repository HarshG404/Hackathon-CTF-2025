{% extends "base.html" %}

{% block title %}XML Data Upload - ICSS India{% endblock %}

{% block extra_js %}
{% if result and result.flag %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        showFlagPopup(
            'xxe',
            "{{ result.flag }}",
            'XXE - XML External Entity Injection',
            'Your XML payload contained an external entity declaration! The server processed it and revealed sensitive data.'
        );
    }, 500);
});
</script>
{% endif %}
{% endblock %}

{% block content %}
<section class="py-5 bg-primary text-white">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8 fade-in-left">
                <h1 class="display-5 mb-3">XML Data Parser</h1>
                <p class="lead">Upload and process XML data files for bulk operations</p>
            </div>
            <div class="col-md-4 fade-in-right text-center">
                <i class="fas fa-file-code" style="font-size: 120px; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-md-6 fade-in-left">
                <div class="card shadow-lg h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-upload"></i> XML Upload</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3" style="font-size:12px;">
                            <i class="fas fa-bug me-1"></i>
                            <strong>CTF Hint:</strong> The XML parser processes external entities! Try an XXE payload.
                        </div>

                        {% if error %}
                        <div class="alert alert-danger fade-in-up">
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                        </div>
                        {% endif %}

                        <form method="POST" action="/xml/upload">
                            <div class="mb-3 fade-in-up">
                                <label class="form-label"><i class="fas fa-file-code text-primary"></i> XML Data</label>
                                <textarea name="xml" class="form-control font-monospace" rows="14"
                                    placeholder="Paste your XML here..." required style="font-size: 13px;">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;students&gt;
  &lt;student&gt;
    &lt;name&gt;John Doe&lt;/name&gt;
    &lt;email&gt;john@example.com&lt;/email&gt;
    &lt;course&gt;AI &amp; ML&lt;/course&gt;
  &lt;/student&gt;
&lt;/students&gt;</textarea>
                                <small class="text-muted">Paste or type your XML data above</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 fade-in-up stagger-3">
                                <i class="fas fa-cogs me-2"></i>Process XML
                            </button>
                        </form>

                        <div class="mt-3 p-3 bg-dark rounded">
                            <small class="text-warning d-block mb-2"><i class="fas fa-skull me-1"></i>XXE Payload to try:</small>
                            <pre class="text-success mb-0" style="font-size:10px; white-space:pre-wrap;">&lt;!DOCTYPE foo [
  &lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;
]&gt;
&lt;data&gt;&amp;xxe;&lt;/data&gt;</pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 fade-in-right">
                {% if result %}
                <div class="card shadow-lg scale-in mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-check-circle"></i> Parsed XML Result</h5>
                    </div>
                    <div class="card-body">
                        <div class="p-3" style="background: #f8f9fa; border-radius: 8px; max-height: 350px; overflow-y: auto;">
                            <pre class="mb-0 font-monospace" style="font-size: 13px;">{{ result | tojson(indent=2) }}</pre>
                        </div>

                        {% if result.flag %}
                        <div class="alert alert-success mt-3 fade-in-up">
                            <h6><i class="fas fa-flag-checkered me-2"></i>FLAG CAPTURED!</h6>
                            <p class="mb-0 font-monospace">{{ result.flag }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="card shadow-lg">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-info-circle text-primary"></i> What is XXE?</h5>
                    </div>
                    <div class="card-body">
                        <p>XML External Entity (XXE) Injection allows attackers to read local files, perform SSRF, or execute RCE by injecting malicious XML entities.</p>
                        <p>When the XML parser resolves <code>&amp;xxe;</code>, it fetches the referenced SYSTEM file!</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}
